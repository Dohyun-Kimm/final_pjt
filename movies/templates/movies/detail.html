{% extends 'base.html' %}

{% load static %}

{% block css %}
  
  <link rel='stylesheet' href="{% static 'movies/css/main.css' %}"/>
{% endblock css %}

{% block js %}
  
  <script src="{% static 'movies/js/main.js' %}" defer></script>
{% endblock js %}

{% block content %}

  <h1>제목: {{ movie.title }}</h1>

  <p> 요약: {{movie.overview}}</p>

  <p>{{movie.release_date}}</p>

  <img src=https://image.tmdb.org/t/p/w500{{movie.poster_path}} alt="">

  
  <p>평점{{movie.vote_average}}</p>

  <p>{{movie.director}}</p>

  <p>{{movie.wise_saying}}</p>

  {% comment %} 댓글입력 창. 리뷰 작성기능, 평점 기능  {% endcomment %}
  <form action="{% url 'movies:comments_create' movie.pk %}" method="POST">
    {% csrf_token %}
    {{comment_form.content}}
    <br>
    {{comment_form.movie_rate}}
    <input type="submit">
  </form>


  {% comment %}  댓글 목록  {% endcomment %}
  <ul>
    {% for comment in comments  %}
    <li>
      <p>{{comment.user.nickName}}</p>
      <span>{{ comment.content}}</span>
      <span>{{ comment.movie_rate }}</span>

      <!-- 좋아요 구현   -->
      <form data-comment-id="{{movie.pk}}">
        {% csrf_token %}
        {% if request.user in movie.like_users.all %}
          <input type="submit" value="좋아요 취소" id="like-{{movie.pk}}">
        {% else %}
          <input type="submit" value="좋아요" id="like-{{article.pk}}">
        {% endif %}
      </form>


      {% comment %} update delete {% endcomment %}
      {% if request.user == comment.user %}
        <a href="{% url 'movies:comments_update' movie.pk comment.pk  %}"> 수정</a>
        <form action="{% url 'movies:comments_delete' movie.pk comment.pk %}" method="POST">
          {% csrf_token %}
          <input type="submit" value="삭제">
        </form>
      {% endif %}
    </li>
    {% endfor %}
  </ul>


{% endblock content %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const forms = document.querySelectorAll('.like-forms')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

  forms.forEach((form) => {
    form.addEventListener('submit', function (event) {
      event.preventDefault()
      // console.log(event.target.dataset)

      const moiveId = event.target.dataset.movieId

      axios({
        method: 'post',
        url: `http://127.0.0.1:8000/moives/${movie_pk}/likes/`,
        headers: {'X-CSRFToken': csrftoken},
      })
        .then((response) => {
          // console.log(response)
          // console.log(response.data)

          const isLiked = response.data.is_liked

          const likeBtn = document.querySelector(`#like-${movieId}`)
          if (isLiked === true) {
            likeBtn.value = '좋아요 취소'
          } else {
            likeBtn.value = '좋아요'
          }
          // likeBtn.value = isLiked ? '좋아요 취소' : '좋아요'
        })
        .catch((error) => {
          console.log(error.response)
        })
    })
  })
</script>

{% endblock script %}